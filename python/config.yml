version: 2.1

description: >
  Build and release steps for Python projects.

executors:
  default:
    docker:
      - image: cimg/python:3.9.2

commands:
  install-dependencies:
    steps:
      - run:
          name: Install Dependencies
          command: |
            pip install .[lint,test,typehinting]
  lint:
    steps:
      - run:
          name: Run flake8
          command: |
            flake8
  test:
    steps:
      - run:
          name: Run nosetests
          command: |
            nosetests
  typehinting:
    steps:
      - run:
          name: Run mypy
          command: |
            mypy ./

  restore-dependencies-cache:
    steps:
      - attach_workspace:
          at: /home/circleci

  update-dependencies-cache:
    steps:
      - persist_to_workspace:
          root: /home/circleci
          paths:
            - .pyenv
            - project

jobs:
  build:
    parameters:
      executor:
        type: executor
        default: default

    executor: << parameters.executor >>

    steps:
      - checkout
      - install-dependencies
      - lint
      - typehinting
      - test
      - update-dependencies-cache
